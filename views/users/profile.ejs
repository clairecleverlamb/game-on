<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css">
    <title>Your profile</title>
</head>
<body>
<%- include('../partials/header') %>
<%- include('../partials/subheader', { pageTitle: 'Your Profile', backLink: '/' }) %>
<%- include('../partials/sidebar') %>

<div class="profile-container">
  <div class="user-info">

    <% if (user.profilePicture) { %>
      <img src="<%= `${user.profilePicture}` %>" alt="Profile Picture" width="100">
    <% } %>
    <h1><%= user.username %></h1>
    <% if (user.fullName) { %>
      <p><strong><%= user.fullName %></strong></p>
    <% } %>
    <p><strong>Email:</strong> <%= user.email %></p>
    <% if (user.location) { %>
      <p><strong>Location:</strong> <%= user.location %></p>
    <% } %>
    <% if (user.sportsInterests) { %>
      <p><strong>Sports Interest:</strong> <%= user.sportsInterests %></p>
    <% } %>
    <p><strong>Games Played:</strong> <%= user.stats.gamePlayed %></p>
    <p><strong>Wins:</strong> <%= user.stats.wins %></p>

    <h3>Games Played</h3>
    <ul>
      <% user.pastGames.filter(game => game.completed).forEach(game => { %>
        <li>
          <a href="/games/<%= game._id %>"><%= game.sport %></a>
          <% if (game.winner && game.winner._id.toString() === user._id.toString()) { %> (Won) <% } %>
        </li>
      <% }) %>
    </ul>

    <h3>Tournaments Joined</h3>
    <ul>
      <% user.tournamentJoined.forEach(tournament => { %>
        <li>
          <a href="/tournaments/<%= tournament._id %>"><%= tournament.name %></a>
          <% if (tournament.completed) { %> (Ended) <% } %>
        </li>
      <% }) %>
    </ul>


    <% if (user.highlightVideos && user.highlightVideos.length > 0) { %>
        <h3>Highlight Videos</h3>
        <% user.highlightVideos.forEach((video, index) => { %>
          <div class="video-container">
            <% if (typeof video === 'string') { %>
              <!-- Legacy string data -->
              <% if (video.includes('youtube.com') || video.includes('youtu.be')) { %>
                <iframe width="200" height="150" src="<%= video.replace('watch?v=', 'embed/') %>" frameborder="0" allowfullscreen></iframe>
              <% } else { %>
                <video src="<%= video %>" controls width="200"></video>
              <% } %>
              <p>Likes: 0 (Legacy video)</p>
            <% } else if (video && video.url) { %>
              <!-- New object structure -->
              <% if (video.url.includes('youtube.com') || video.url.includes('youtu.be')) { %>
                <iframe width="200" height="150" src="<%= video.url.replace('watch?v=', 'embed/') %>" frameborder="0" allowfullscreen></iframe>
              <% } else { %>
                <video src="<%= video.url %>" controls width="200"></video>
              <% } %>
              <p>Likes: <%= video.likes ? video.likes.length : 0 %></p>
              <% if (user._id.toString() !== req.session.user._id.toString()) { %>
                <% if (video.likes && video.likes.some(like => like.toString() === req.session.user._id.toString())) { %>
                  <form action="/users/<%= user._id %>/unlike/<%= index %>" method="POST">
                    <button type="submit">Unlike</button>
                  </form>
                <% } else { %>
                  <form action="/users/<%= user._id %>/like/<%= index %>" method="POST">
                    <button type="submit">Like</button>
                  </form>
                <% } %>
              <% } %>
            <% } else { %>
              <!-- Malformed entry -->
              <p>Invalid video entry</p>
            <% } %>
          </div>
        <% }) %>
      <% } %>

    <a href="/users/edit">Edit Profile</a>
  </div>

  <div class="events">
    <div class="create-buttons">
      <a href="/games/new">Create Game</a>
      <a href="/tournaments/new">Create Tournament</a>
    </div>

    <div class="games-list">
      <h2>Upcoming Games</h2>
      <% if (games && games.length > 0) { %>
        <% games.forEach(game => { %>
          <%- include('../partials/game-item', { game }) %>
        <% }) %>
      <% } else { %>
        <p>No upcoming games yet.</p>
      <% } %>
    </div>

    <div class="tournaments-list">
      <h2>Upcoming Tournaments</h2>
      <% if (tournaments && tournaments.length > 0) { %>
        <% tournaments.forEach(tournament => { %>
          <%- include('../partials/tournament-item', { tournament }) %>
        <% }) %>
      <% } else { %>
        <p>No upcoming tournaments yet.</p>
      <% } %>
    </div>
  </div>
  <%- include('../partials/weather', { location: user.location || 'San Francisco' }) %>
</div>
<%- include('../partials/calendar') %>
<%- include('../partials/footer') %>
</body>
</html>